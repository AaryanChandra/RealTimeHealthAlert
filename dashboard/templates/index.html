<!DOCTYPE html>
<html>
<head>
    <title>Health Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
<div class="container mt-4">
    <h2 class="mb-4">ðŸ©º Real-Time Health Dashboard</h2>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <form method="get" class="d-flex align-items-center">
            <label for="patient_id" class="me-2">Select Patient:</label>
            <select name="patient_id" onchange="this.form.submit()" class="form-select" style="width: 200px;">
                {% for p in range(1, 6) %}
                    <option value="{{ p }}" {% if selected_id == p|string %}selected{% endif %}>
                        {{ patients[p|string].name if p|string in patients else "Patient " ~ p }}
                    </option>
                {% endfor %}
            </select>
        </form>
        <a href="/alerts" class="btn btn-danger">View Alert History</a>
    </div>

    <h5 class="mb-3">
        Heart Rate for:
        {{ patients[selected_id].name if selected_id in patients else 'Patient ' ~ selected_id }}
    </h5>

    <canvas id="heartChart" height="100"></canvas>

    <hr class="my-4">

    <h4>Latest Readings</h4>
    <table class="table table-bordered">
        <thead class="table-dark">
            <tr>
                <th>Patient</th>
                <th>Heart Rate</th>
                <th>SpO2</th>
                <th>Temperature (Â°C)</th>
                <th>Severity</th>
                <th>Timestamp</th>
            </tr>
        </thead>
        <tbody>
            {% for row in records %}
                <tr class="{% if row.severity == 'Critical' %}table-danger{% elif row.severity == 'Warning' %}table-warning{% else %}table-success{% endif %}">
                    <td>
                        {{ patients[row.patient_id].name if row.patient_id in patients else 'Patient ' ~ row.patient_id }}
                        (ID: {{ row.patient_id }})
                    </td>
                    <td>{{ row.heart_rate }}</td>
                    <td>{{ row.spo2 }}</td>
                    <td>{{ row.temperature }}</td>
                    <td>
                        <span class="badge {% if row.severity == 'Critical' %}bg-danger{% elif row.severity == 'Warning' %}bg-warning text-dark{% else %}bg-success{% endif %}">
                            {{ row.severity }}
                        </span>
                    </td>
                    <td>{{ row.timestamp }}</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
    const labels = {{ history | map(attribute='timestamp') | list | safe }};
    const values = {{ history | map(attribute='heart_rate') | list | safe }};

    const ctx = document.getElementById('heartChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'Heart Rate',
                data: values,
                borderColor: 'red',
                backgroundColor: 'rgba(255,0,0,0.2)',
                tension: 0.3
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: false
                }
            }
        }
    });
</script>
</body>
</html>
